# Story 1.5: End-to-End Foundation Integration

## Status
Draft

## Story
**As a** developer,
**I want** to complete the foundation integration with end-to-end testing,
**so that** I can validate the complete foundation loop works before proceeding to real features

## Acceptance Criteria
1. One developer can clone repo, run server and desktop, and complete a fake job E2E
2. Desktop can open `.mrc`, display metadata, connect to WS, and show fake mask overlay at 1 Hz
3. Entire loop runs on CPU with no GPU required
4. All foundation components work together seamlessly
5. Basic error handling and recovery works

## Tasks / Subtasks
- [ ] Task 1: Integrate desktop with server (AC: 1, 2)
  - [ ] Connect desktop client to FastAPI server health endpoints
  - [ ] Implement WebSocket connection from desktop to server
  - [ ] Add server connection status indicator in desktop UI
  - [ ] Handle connection failures and retries gracefully
- [ ] Task 2: Implement fake job workflow (AC: 1, 2)
  - [ ] Create fake job submission from desktop to server
  - [ ] Implement job status polling and display
  - [ ] Add fake mask overlay display in napari viewer
  - [ ] Ensure 1 Hz preview streaming works end-to-end
- [ ] Task 3: Add error handling and recovery (AC: 5)
  - [ ] Implement connection error handling in desktop
  - [ ] Add server error responses and client handling
  - [ ] Create graceful degradation when server unavailable
  - [ ] Add user-friendly error messages and recovery options
- [ ] Task 4: Create end-to-end testing (AC: 1)
  - [ ] Write integration tests for complete workflow
  - [ ] Test desktop-server communication
  - [ ] Validate WebSocket streaming functionality
  - [ ] Test error scenarios and recovery
- [ ] Task 5: Document and validate setup (AC: 1)
  - [ ] Update README with complete setup instructions
  - [ ] Create troubleshooting guide for common issues
  - [ ] Validate setup works on clean environment
  - [ ] Add performance benchmarks for foundation components

## Dev Notes

### Previous Story Insights
Stories 1.1-1.4 provide all foundation components. This story integrates them into a complete working system.

### Data Models
**Job Record** [Source: architecture/4-data-models-schemas.md#job-record]:
- Tracks job_id, state, params, artifacts, errors
- State transitions: pending → running → completed

**Preview Message** [Source: architecture/4-data-models-schemas.md#preview-message]:
- JSON with scale, shape, dtype, base64 payload
- Used for fake mask overlay streaming

### API Specifications
**Complete API Integration** [Source: architecture/7-api-specifications.md]:
- Health & Info: `/v1/healthz`, `/v1/server/info`
- Jobs: `POST /jobs`, `GET /jobs/{id}`, `DELETE /jobs/{id}`
- WebSocket: `/ws/jobs/{id}` for preview streaming

### File Locations
**Desktop Application** [Source: architecture/2-detailed-component-architecture.md#21-desktop-application]:
- UI: Qt menus, dialogs, status bar
- Visualization: napari (3D volume, labels overlays)
- Networking: REST for control/data, WS for streaming previews
- Data Structures: Volume object, JobConfig, Mask overlay layers

**Inference Server** [Source: architecture/2-detailed-component-architecture.md#22-inference-server]:
- API Layer (FastAPI)
- Job Orchestrator (async queue)
- Artifact Manager (mask.mrc, NIfTI, NRRD, stats.json)

### Technical Constraints
**Runtime Requirements** [Source: architecture/5-infrastructure-deployment.md#resources]:
- Must run on CPU for MVP (no GPU required)
- Local development environment setup

**Performance** [Source: architecture/6-runtime-design-concurrency.md#desktop]:
- Desktop remains ≥30 FPS on typical 512³ volumes
- Efficient WebSocket streaming at 1 Hz

### Testing
**Testing Standards** [Source: architecture/5-infrastructure-deployment.md#observability]:
- End-to-end integration testing
- WebSocket streaming validation
- Error handling and recovery testing
- Performance benchmarking

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-13 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be added here*
