# Story 3.2: Implement Preview Downsampling and Streaming

## Status
Draft

## Story
**As a** developer,
**I want** real-time preview streaming during inference,
**so that** users can see segmentation progress as it happens

## Acceptance Criteria
1. Real tomogram emits previews every 1â€“2 seconds during inference
2. Preview downsampling maintains visual quality
3. WebSocket streaming delivers previews with low latency
4. Preview messages contain proper JSON format with base64 payload
5. Desktop client displays previews in real-time

## Tasks / Subtasks
- [ ] Task 1: Implement preview downsampling (AC: 2)
  - [ ] Create downsampling algorithms for segmentation masks
  - [ ] Implement multi-resolution preview generation
  - [ ] Add quality optimization for visual clarity
  - [ ] Optimize downsampling performance
- [ ] Task 2: Create preview streaming system (AC: 1, 3)
  - [ ] Implement periodic preview generation during inference
  - [ ] Add preview message formatting and serialization
  - [ ] Create WebSocket streaming infrastructure
  - [ ] Implement preview queuing and delivery
- [ ] Task 3: Implement preview message format (AC: 4)
  - [ ] Define Preview Message schema with scale, shape, dtype, base64 payload
  - [ ] Create message serialization/deserialization
  - [ ] Add message validation and error handling
  - [ ] Implement proper message ordering and timestamps
- [ ] Task 4: Add desktop preview integration (AC: 5)
  - [ ] Update desktop client to receive real previews
  - [ ] Implement preview overlay display in napari
  - [ ] Add preview quality and performance controls
  - [ ] Handle preview updates and layer management
- [ ] Task 5: Add performance optimization (AC: 1, 3)
  - [ ] Optimize preview generation frequency and quality
  - [ ] Implement efficient WebSocket message delivery
  - [ ] Add preview caching and compression
  - [ ] Monitor preview streaming performance

## Dev Notes

### Previous Story Insights
Story 3.1 provides nnU-Net inference. This story adds real-time preview streaming during inference.

### Data Models
**Preview Message** [Source: architecture/4-data-models-schemas.md#preview-message]:
- JSON with scale, shape, dtype, base64 payload
- Must be efficiently streamable and displayable

### API Specifications
**WebSocket** [Source: architecture/7-api-specifications.md#websocket]:
- `/ws/jobs/{id}`: progress, preview, completed, error messages
- Low latency streaming for real-time updates

**Protocols** [Source: architecture/2-detailed-component-architecture.md#23-protocols]:
- Previews: WebSocket for low latency streaming

### File Locations
**Inference Server** [Source: architecture/2-detailed-component-architecture.md#22-inference-server]:
- nnU-Net Runner (sliding window, periodic previews)
- Job Orchestrator (async queue) - preview scheduling

**Desktop Application** [Source: architecture/2-detailed-component-architecture.md#21-desktop-application]:
- Networking: WebSocket for streaming previews
- Data Structures: Mask overlay layers

### Technical Constraints
**Performance** [Source: architecture/6-runtime-design-concurrency.md#server]:
- Efficient preview generation and streaming
- Low latency WebSocket delivery

**Runtime Requirements** [Source: architecture/5-infrastructure-deployment.md#resources]:
- Real-time preview streaming at 1-2 second intervals
- Efficient downsampling and compression

### Testing
**Testing Standards** [Source: architecture/5-infrastructure-deployment.md#observability]:
- Preview streaming performance testing
- WebSocket latency and reliability testing
- Preview quality validation
- Desktop integration testing

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be added here*
