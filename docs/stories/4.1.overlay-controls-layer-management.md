# Story 4.1: Implement Overlay Controls and Napari Layer Management

## Status
Draft

## Story
**As a** developer,
**I want** overlay controls and napari layer management,
**so that** users can control mask overlays and visualization settings

## Acceptance Criteria
1. Previews appear live during inference with proper overlay management
2. Final mask replaces preview automatically when job completes
3. Opacity slider and colormap selector work correctly
4. 3D volume toggle functions properly
5. Desktop remains ≥30 FPS on typical 512³ volumes

## Tasks / Subtasks
- [ ] Task 1: Implement overlay layer management (AC: 1, 2)
  - [ ] Create preview layer management and updates
  - [ ] Implement final mask layer replacement
  - [ ] Add layer visibility and ordering controls
  - [ ] Handle layer transitions and updates smoothly
- [ ] Task 2: Add visualization controls (AC: 3, 4)
  - [ ] Implement opacity slider for mask overlays
  - [ ] Add colormap selector for different visualization modes
  - [ ] Create 3D volume toggle functionality
  - [ ] Add rendering mode controls (MIP, translucent, etc.)
- [ ] Task 3: Optimize performance (AC: 5)
  - [ ] Implement efficient layer updates and rendering
  - [ ] Add viewport culling and LOD for large volumes
  - [ ] Optimize memory usage for overlay layers
  - [ ] Add performance monitoring and optimization
- [ ] Task 4: Add user interface controls (AC: 3, 4)
  - [ ] Create dock widget for overlay controls
  - [ ] Add keyboard shortcuts for common operations
  - [ ] Implement control panel for visualization settings
  - [ ] Add tooltips and help for user guidance
- [ ] Task 5: Add layer synchronization (AC: 1, 2)
  - [ ] Implement preview-to-final mask transition
  - [ ] Add layer state persistence and restoration
  - [ ] Create layer metadata and annotation support
  - [ ] Handle multiple job overlays simultaneously

## Dev Notes

### Previous Story Insights
Epic 3 provides real inference and preview streaming. This story adds advanced visualization controls for the desktop client.

### Data Models
**Preview Message** [Source: architecture/4-data-models-schemas.md#preview-message]:
- JSON with scale, shape, dtype, base64 payload
- Used for live preview overlay updates

**Desktop Application** [Source: architecture/2-detailed-component-architecture.md#21-desktop-application]:
- Visualization: napari (3D volume, labels overlays)
- Data Structures: Volume object, JobConfig, Mask overlay layers

### API Specifications
**WebSocket** [Source: architecture/7-api-specifications.md#websocket]:
- `/ws/jobs/{id}`: progress, preview, completed, error messages
- Used for real-time preview updates

### File Locations
**Desktop Application** [Source: architecture/2-detailed-component-architecture.md#21-desktop-application]:
- UI: Qt menus, dialogs, status bar
- Visualization: napari (3D volume, labels overlays)
- Data Structures: Mask overlay layers

### Technical Constraints
**Performance** [Source: architecture/6-runtime-design-concurrency.md#desktop]:
- Desktop remains ≥30 FPS on typical 512³ volumes
- Efficient layer management and rendering

**Runtime Requirements** [Source: architecture/5-infrastructure-deployment.md#resources]:
- Must run on CPU for MVP (no GPU required)
- Efficient memory management for overlay layers

### Testing
**Testing Standards** [Source: architecture/5-infrastructure-deployment.md#observability]:
- Performance testing with large volumes
- Layer management and transition testing
- UI control functionality testing
- Memory usage and optimization testing

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
*To be filled by dev agent*

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
*To be filled by dev agent*

## QA Results
*Results from QA Agent review will be added here*
