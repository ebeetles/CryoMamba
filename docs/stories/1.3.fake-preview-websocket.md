# Story 1.3: Implement Fake Preview WebSocket Streaming

## Status
Ready for Review

## Story
**As a** developer,
**I want** fake preview streaming via WebSocket for early UI testing,
**so that** I can validate the preview streaming architecture before real inference

## Acceptance Criteria
1. WebSocket server accepts connections on `/ws/jobs/{id}`
2. Fake mask data streams at 1 Hz frequency
3. Desktop client can connect and receive preview messages
4. Preview messages contain proper JSON format with base64 payload
5. Entire system runs on CPU with no GPU required

## Tasks / Subtasks
- [x] Task 1: Implement WebSocket server endpoints (AC: 1)
  - [x] Create WebSocket route handler in FastAPI
  - [x] Add connection management and client tracking
  - [x] Implement proper WebSocket lifecycle handling
  - [x] Add connection authentication and validation
- [x] Task 2: Create fake preview data generation (AC: 2, 4)
  - [x] Generate random mask data matching volume dimensions
  - [x] Implement base64 encoding for preview payload
  - [x] Create proper JSON message format
  - [x] Add configurable streaming frequency (1 Hz)
- [x] Task 3: Implement preview message format (AC: 4)
  - [x] Define Preview Message schema with scale, shape, dtype, base64 payload
  - [x] Create message serialization/deserialization
  - [x] Add message validation and error handling
  - [x] Implement proper message ordering and timestamps
- [x] Task 4: Add desktop WebSocket client (AC: 3)
  - [x] Create WebSocket client connection manager
  - [x] Implement message reception and parsing
  - [x] Add connection retry and error handling
  - [x] Create preview data display integration
- [x] Task 5: Add testing and validation (AC: 5)
  - [x] Create unit tests for WebSocket endpoints
  - [x] Add integration tests for preview streaming
  - [x] Test connection handling and error scenarios
  - [x] Validate message format compliance

## Dev Notes

### Previous Story Insights
Stories 1.1 and 1.2 provide the server and desktop foundations. This story connects them via WebSocket for preview streaming.

### Data Models
**Preview Message** [Source: architecture/4-data-models-schemas.md#preview-message]:
- JSON with scale, shape, dtype, base64 payload
- Must match volume dimensions for proper overlay

### API Specifications
**WebSocket** [Source: architecture/7-api-specifications.md#websocket]:
- `/ws/jobs/{id}`: progress, preview, completed, error messages
- Low latency streaming for real-time updates

**Protocols** [Source: architecture/2-detailed-component-architecture.md#23-protocols]:
- Previews: WebSocket for low latency streaming

### File Locations
**Server Components** [Source: architecture/2-detailed-component-architecture.md#22-inference-server]:
- API Layer (FastAPI) - WebSocket endpoint implementation
- Job Orchestrator (async queue) - preview scheduling

**Desktop Components** [Source: architecture/2-detailed-component-architecture.md#21-desktop-application]:
- Networking: WebSocket for streaming previews
- Data Structures: Mask overlay layers

### Technical Constraints
**Runtime Requirements** [Source: architecture/5-infrastructure-deployment.md#resources]:
- Must run on CPU for MVP (no GPU required)
- 1 Hz streaming frequency for testing

**Performance** [Source: architecture/6-runtime-design-concurrency.md#server]:
- Efficient WebSocket connection management
- Proper message queuing and delivery

### Testing
**Testing Standards** [Source: architecture/5-infrastructure-deployment.md#observability]:
- WebSocket connection testing
- Message format validation
- Performance testing for streaming frequency
- Error handling and reconnection testing

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Initial story creation | Scrum Master |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
Claude Sonnet 4 (Full Stack Developer Agent)

### Debug Log References
- WebSocket server implementation: `/Users/elwinli/CryoMamba/app/routes/websocket.py`
- Preview message models: `/Users/elwinli/CryoMamba/app/models/preview.py`
- Desktop WebSocket client: `/Users/elwinli/CryoMamba/napari_cryomamba/napari_cryomamba/websocket_client.py`
- Integration tests: `/Users/elwinli/CryoMamba/test_websocket_integration.py`

### Completion Notes List
- ✅ WebSocket server endpoints implemented with connection management
- ✅ Fake preview data generation with 1 Hz streaming frequency
- ✅ Preview message format with proper JSON schema and base64 encoding
- ✅ Desktop WebSocket client with Qt integration and napari display
- ✅ Comprehensive testing including unit tests and integration tests
- ✅ All acceptance criteria met and validated

### File List
**New Files Created:**
- `app/routes/websocket.py` - WebSocket server endpoints and connection management
- `app/models/preview.py` - Preview message models and validation
- `napari_cryomamba/napari_cryomamba/websocket_client.py` - Desktop WebSocket client
- `tests/test_websocket.py` - Unit tests for WebSocket functionality
- `test_websocket_integration.py` - Integration test script

**Modified Files:**
- `app/main.py` - Added WebSocket router
- `app/routes/jobs.py` - Integrated WebSocket broadcasting and fake preview streaming
- `napari_cryomamba/napari_cryomamba/widget.py` - Added WebSocket client integration and job controls

### Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2024-12-19 | 1.0 | Initial story creation | Scrum Master |
| 2024-12-19 | 1.1 | Complete WebSocket implementation | Dev Agent |

## QA Results
*Results from QA Agent review will be added here*
